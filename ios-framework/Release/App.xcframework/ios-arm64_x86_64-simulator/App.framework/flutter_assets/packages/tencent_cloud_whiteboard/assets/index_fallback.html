<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://res.qcloudtiw.com/board/third/videojs/1.0.0/video-js.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="teboard"></div>
    <div id="decorator"></div>
    <script src="./axios.min.js"></script>
    <script src="./cos-js-sdk-v5.min.js"></script>
    <script src="./TEduBoard.min.js"></script>
    <script src="./video.min.js"></script>
    <script>
      let teduBoardInstance;
      let cos;
      let _coses = new Map();
      let initCosParam = {};
      window.callFunc = (data) => {
        const { key, params } = data;
        if (key === "updateBgDotShow") {
          updateBgDotShow(...params);
          return "Update Success";
        }

        if (key === "cancelTask") {
          cancelTask(...params);
          return "Cancel Success";
        }

        if (key === "pauseTask") {
          pauseTask(...params);
          return "Pause Success";
        }

        if (key === "restartTask") {
          restartTask(...params);
          return "Restart Success";
        }

        if (key === "initCos") {
          console.log("sliceUploadFile", params);
          initCos(...params);
          return "Init Success";
        }

        if (key === "sliceUploadFile") {
          console.log("sliceUploadFile", params);
          sliceUploadFile(...params);
          return "Init Success";
        }

        if (key === "setToolType") {
          if (params[1]) {
            window.flutter_inappwebview.callHandler("boardListener", {
              eventKey: "TEB_TOOLTYPE_CHANGE",
              args: [params[0]],
            });
          }
        }

        if (key === "initBoard" && params) {
          initBoard(...params);
          return "Init Success";
        } else {
          try {
            return teduBoardInstance[key](...params);
          } catch (error) {
            console.log("error", error);
          }
        }
      };

      updateBgDotShow = (show) => {
        document.getElementById("decorator").style.display = show
          ? "block"
          : "none";
      };

      initCos = ({ tmpSecretId, tmpSecretKey, sessionToken, expiredTime }) => {
        initCosParam = {
          tmpSecretId,
          tmpSecretKey,
          sessionToken,
          expiredTime,
        };
      };

      sliceUploadFile = ({
        bucketName,
        region,
        file,
        uploadKey,
        specifiedContentType,
      }) => {
        const fileName = uploadKey.split("/").pop();
        const fileObj = base64ToBlob(file, specifiedContentType);
        const { tmpSecretId, tmpSecretKey, sessionToken, expiredTime } =
          initCosParam;
        const cos = new COS({
          getAuthorization: (options, callback) => {
            callback({
              TmpSecretId: tmpSecretId,
              TmpSecretKey: tmpSecretKey,
              SecurityToken: sessionToken,
              ExpiredTime: expiredTime,
            });
          },
        });
        cos.uploadFile(
          {
            Bucket: bucketName,
            Region: region,
            Body: fileObj,
            Key: uploadKey,
            ContentType: specifiedContentType,
            onTaskReady: (taskId) => {
              // 保存COS对象，方便取消上传任务
              _coses.set(taskId, cos);
              window.flutter_inappwebview.callHandler("boardListener", {
                eventKey: "onTaskReady",
                args: [taskId],
              });
            },
            onHashProgress: () => {},
            onProgress: (progress) => {
              if (progress) {
                window.flutter_inappwebview.callHandler("boardListener", {
                  eventKey: "onUploadProgress",
                  args: [
                    {
                      loaded: progress.loaded,
                      total: progress.total,
                      speed: progress.speed,
                      percent: progress.percent,
                    },
                  ],
                });
              }
            },
          },
          (err, data) => {
            if (err) {
              window.flutter_inappwebview.callHandler("boardListener", {
                eventKey: "onUploadError",
                args: [
                  {
                    code: err.code || err.statusCode,
                    message: err.message || err.statusMessage,
                  },
                ],
              });
            } else {
              if (data && data.statusCode === 200) {
                window.flutter_inappwebview.callHandler("boardListener", {
                  eventKey: "onUploadSuccess",
                  args: [data],
                });
              }
            }
            // 删除cos对象
            for (const [key, value] of _coses.entries()) {
              if (value === cos) {
                _coses.delete(key);
                break;
              }
            }
          }
        );
      };

      cancelTask = (taskId) => {
        const cos = _coses.get(taskId);
        if (cos) {
          cos.cancelTask(taskId);
          _coses.delete(taskId);
        }
      };

      pauseTask = (taskId) => {
        const cos = _coses.get(taskId);
        if (cos) {
          cos.pauseTask(taskId);
        }
      };

      restartTask = (taskId) => {
        const cos = _coses.get(taskId);
        if (cos) {
          cos.restartTask(taskId);
        }
      };

      document.addEventListener(
        "touchstart",
        (event) => {
          // 获取触摸点
          const touch = event.touches[0];
          const startX = touch.clientX;
          const startY = touch.clientY;

          // 记录开始时间
          const startTime = Date.now();

          // 触摸结束事件处理
          const touchEndHandler = (endEvent) => {
            // 获取结束触摸点
            const endTouch = endEvent.changedTouches[0];
            const endX = endTouch.clientX;
            const endY = endTouch.clientY;

            // 计算移动距离
            const moveDistance = Math.sqrt(
              Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2)
            );

            // 计算触摸时长
            const touchDuration = Date.now() - startTime;

            // 只有满足以下条件才触发点击事件：
            // 1. 移动距离小于10像素
            // 2. 触摸时长小于300毫秒
            if (moveDistance < 10 && touchDuration < 300) {
              const isClickOutSideBoard = event.target.id === "teboard";
              window.flutter_inappwebview.callHandler("boardListener", {
                eventKey: "onBoardTouchStart",
                args: [isClickOutSideBoard],
              });
            } else {
              window.flutter_inappwebview.callHandler("boardListener", {
                eventKey: "onDrawInBoard",
                args: [],
              });
            }

            // 移除事件监听
            document.removeEventListener("touchend", touchEndHandler);
          };

          // 添加触摸结束事件监听
          document.addEventListener("touchend", touchEndHandler);
        },
        { passive: false }
      );

      window.addBoardListener = (eventKey) => {
        try {
          teduBoardInstance.on(eventKey, (...args) => {
            const keys = [
              "TEB_ADDBOARD",
              "TEB_DELETEBOARD",
              "TEB_ADDH5PPTFILE",
              "TEB_ADDFILE",
              "TEB_GOTOBOARD",
              "TEB_SWITCHFILE",
              "TEB_HISTROYDATA_SYNCCOMPLETED",
            ];
            if (keys.includes(eventKey)) {
              const currentIsBoard =
                teduBoardInstance.getCurrentFile() === "#DEFAULT";
              updateBgDotShow(currentIsBoard);
            }
            window.flutter_inappwebview.callHandler("boardListener", {
              eventKey,
              args,
            });
          });
        } catch (error) {
          console.log("【【【error", error);
        }
      };

      function base64ToFile(base64, filename, mimeType) {
        // 去掉 data url 头部信息（如果有的话）
        let arr = base64.split(",");
        let bstr = atob(arr.length > 1 ? arr[1] : arr[0]);
        let n = bstr.length;
        let u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        // 构造 File
        return new File([u8arr], filename);
      }

      function base64ToBlob(base64, mimeType) {
        const byteChars = atob(base64);
        const byteNumbers = new Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) {
          byteNumbers[i] = byteChars.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mimeType });
      }

      window.initBoard = (initParams) => {
        try {
          teduBoardInstance = new TEduBoard({
            id: "teboard",
            authConfig: {
              drawEnable: true,
            },
            ...initParams,
          });
        } catch (error) {
          console.log("error", error);
        }
        return null;
      };
    </script>
  </body>
  <style>
    html,
    body,
    #teboard,
    #decorator {
      width: 100%;
      height: 100%;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }
    #decorator {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 99;
      background-image: radial-gradient(
        circle 2.5px at center,
        rgba(217, 217, 217, 0.3) 100%,
        transparent 101%
      );
      background-repeat: repeat;
      background-size: 25px 25px;
    }
  </style>
</html>